name: CI (Laravel) - test & auto-merge

# Execute on pushes to any branch except main
on:
  push:
    branches-ignore: [ main ]
  # opcional: també als pull requests cap a qualsevol branca
  pull_request: {}

# Necessitem permisos per a fer merge via API
permissions:
  contents: write

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_sqlite
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          mkdir -p database
          touch database/database.sqlite
          php artisan migrate --force

      - name: Run tests
        run: php artisan test --no-coverage

  merge:
    # Només s'executa si 'tests' ha acabat correctament
    needs: tests
    runs-on: ubuntu-latest
    if: ${{ always() && needs.tests.result == 'success' }}
    env:
      BRANCH_TO_MERGE: ${{ github.ref_name }}
    steps:
      - name: Checkout (for context)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge branch into main via API
        uses: actions/github-script@v6
        with:
          script: |
            const branch = process.env.BRANCH_TO_MERGE;
            if (!branch) {
              core.setFailed('No branch specified to merge.');
            } else if (branch === 'main') {
              core.info('Branch is main — nothing to merge.');
            } else {
              core.info(`Attempting to merge branch '${branch}' into 'main'...`);
              try {
                const result = await github.repos.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: 'main',
                  head: branch
                });
                core.info(`Merge result: ${JSON.stringify(result.data)}`);
              } catch (err) {
                core.setFailed(`Merge failed: ${err.message}`);
              }
            }

      - name: Finish
        run: echo "Merge step finished."

